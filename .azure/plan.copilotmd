# Azure Deployment Plan for StudentManagementSystem Project
## **Goal**
Based on the project to provide a plan to deploy the project to Azure using AZD. 

## **Project Information**
**StudentManagementSystem**  
- **Stack**: Spring Boot (Java 17)  
- **Type**: Student Management System web app  
- **Containerization**: Dockerfile present  
- **Dependencies**: MySQL database  
- **Hosting**: Azure Container Apps

## **Azure Resources Architecture**
> **Install the mermaid extension in IDE to view the architecture.**
```mermaid
graph TD
%% Services
svcazurecontainerapps_studentmanagementsystem["`Name: StudentManagementSystem
Path: f:\Console -based - managment system\StudentManagementSystem
Language: java`"]
subgraph "Compute Resources"
%% Resources
subgraph containerappenv["Azure Container Apps (ACA) Environment"]
azurecontainerapps_studentmanagementsystem("`StudentManagementSystem (Azure Container App)`")
azuredatabaseformysql_mysql("`MySQL (Azure Database for MySQL)`")
end
containerappenv:::cluster
end
%% Relationships
svcazurecontainerapps_studentmanagementsystem --> |"hosted on"| azurecontainerapps_studentmanagementsystem
azurecontainerapps_studentmanagementsystem --> |"connects to"| azuredatabaseformysql_mysql
```

- The container app hosts the StudentManagementSystem service.
- The app connects to the Azure Database for MySQL for data storage.

## **Recommended Azure Resources**
Application StudentManagementSystem:
- Hosting Service Type: Azure Container Apps
- SKU: Consumption (serverless, pay-per-use)
- Configuration:
    - language: java
    - Environment Variables: ["SPRING_DATASOURCE_URL", "SPRING_DATASOURCE_USERNAME", "SPRING_DATASOURCE_PASSWORD"]
    - dockerFilePath: Dockerfile
    - dockerContext: .
- Dependencies Resource:
    - Dependency Name: MySQL
    - SKU: Basic (Burstable, 1-2 vCores)
    - Service Type: Azure Database for MySQL
    - Connection Type: connection string
    - Environment Variables: ["SPRING_DATASOURCE_URL", "SPRING_DATASOURCE_USERNAME", "SPRING_DATASOURCE_PASSWORD"]

## **Recommended Supporting Services**:
- Application Insights
- User-Assigned Managed Identity
- Log Analytics Workspace: set all app service to connect to this
- Key Vault: Create a Key Vault to store database connection string.
- Container Registry

## **Recommended Security Configurations**:
- User-Assigned Managed Identity must have permissions into the Key Vault.
- User-Assigned Managed Identity must be assigned to all supported resources
- AcrPull role assignment: User managed identity must have **AcrPull** role ("7f951dda-4ed3-4680-a7ca-43fe172d538d") assigned to the container registry.

## **Execution Step**
> **Below are the steps for Copilot to follow; ask Copilot to update or execute this plan. Add check list for the steps.**
Execution Steps:
1. Containerization:
    - If Dockerfiles exist, list their paths.
    - If missing, generate required Dockerfiles and build scripts, as well as compose.yaml if required. Agent must create Dockerfile first before deployment!
    - Ensure the repo is analyzed using appmod-analyze-repository.
    - Based on that response, use appmod-plan-generate-dockerfile to generate the required Dockerfiles. Agent must create Dockerfile first before deployment!
    - Output: Docker artifacts
2. Create Azure Infrastructure Files for AZD:
    1. Provisioning tool: AZD. Expected files: azure.yaml, infra/main.bicep, infra/main.parameters.json
    2. Grab current subscriptionID, call tool `appmod-get-available-region-sku` to get available region and SKUs for all needed Azure resource types.
    3. If expected files exist, please follow the below steps:
        - (Fill in with existing file paths) Existing file paths: 
        - Check if the Azure resources in the existing files match what we required in the plan. If not, add steps to update the existing files with missing Azure resource.
        - Generating Files: No
    4. If expected files do not exist, please follow the below steps:
        - Generate the missing expected files, call tool `appmod-get-iac-rules` to get the rules for file generation.
        - Call `get_errors` on the generated files and iterate on any errors.
        - Generating Files: azure.yaml, infra/main.bicep, infra/main.parameters.json
    5. Fix the bicep files and retry if there's any error in the provisioning files. Use `get_errors` tool if available to help look for errors.
3. Env setup for azd {COPY the steps for 'Env set up' directly.}:
    1. Install AZ CLI and AZD if not installed.
    2. Run 'azd env new <envName> --no-prompt' to create a new environment, generating a name for the user. If there's existing environment, check if the environment matches the requirements.
    3. Review infra/main.bicep and infra/main.parameters.bicep for environment variables. Set these for the user using azd env set <key> <value>. Use default values (from AZ CLI) if not provided by the user. Subscription ID is always required.
    4. Set the subscription: Use default subscription
    5. Set AZURE_RESOURCE_GROUP environment variable. The region of the resource group does not have to match its inner resources. Check if Bicep is deployed with resource group scope. If so, CREATE a resource group with AZ CLI.
4. Deployment:
    1. Run `azd provision --preview --no-prompt` to dry run your infrastructure and confirm everything is well-formed.
    2. Azd App Deployment:
        1. Run `azd up --no-prompt`. Iterate on any errors, and retry.
        2. If for some reason you needed to change regions, you must first call `azd down --force --no-prompt` to reset the resources.
    3. Deployment Validation:
        1. Check the application log with tool `appmod-get-azd-app-logs` to ensure the services are running.
5. Summarize Deployment Result:
    1. Use `appmod-summarize-result` tool to summarize the deployment result.
    2. Generating files: .azure/summary.copilotmd

## **Progress Tracking**
- Copilot must create and update `.azure/progress.copilotmd` after each step.  
- Progress should include:  
  - ‚úÖ Completed tasks  
  - üî≤ Pending tasks  
  - ‚ùå Failed tasks with error notes
If a script fails, log the error, regenerate/fix the script, and retry until the step completes.  
- Example format:
- [x] Containerization complete (Dockerfile found at ./Dockerfile)
- [] Deployment in progress
  - Attempt 1 failed: ACR push error (unauthorized).
  - Fixed by regenerating deploy script with correct az acr login. Retrying...